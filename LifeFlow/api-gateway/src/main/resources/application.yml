# API Gateway Configuration
# Spring Cloud Gateway with Resilience4j

# ===== SERVER CONFIG =====
server:
  port: 8000
  servlet:
    context-path: /
  shutdown: graceful

# ===== SPRING BOOT =====
spring:
  application:
    name: api-gateway
  
  # ===== CLOUD GATEWAY CONFIG =====
  cloud:
    gateway:
      enabled: true
      # Define routes
      routes:
        # IDENTITY SERVICE
        - id: identity-register
          uri: http://identity-service:8001
          predicates:
            - Path=/api/v1/auth/register
            - Method=POST
          filters:
            - StripPrefix=2
        
        - id: identity-login
          uri: http://identity-service:8001
          predicates:
            - Path=/api/v1/auth/login
            - Method=POST
          filters:
            - StripPrefix=2
        
        - id: identity-users
          uri: http://identity-service:8001
          predicates:
            - Path=/api/v1/users/**
          filters:
            - StripPrefix=2
            - name: JwtAuthenticationFilter
        
        # DONOR SERVICE
        - id: donor-service
          uri: http://donor-service:8002
          predicates:
            - Path=/api/v1/donors/**
          filters:
            - StripPrefix=2
            - name: JwtAuthenticationFilter
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenish-rate: 100
                redis-rate-limiter.burst-capacity: 200
        
        # INVENTORY SERVICE
        - id: inventory-service
          uri: http://inventory-service:8003
          predicates:
            - Path=/api/v1/inventory/**
          filters:
            - StripPrefix=2
            - name: JwtAuthenticationFilter
        
        # REQUEST SERVICE
        - id: request-blood
          uri: http://request-service:8004
          predicates:
            - Path=/api/v1/blood-requests
            - Method=POST
          filters:
            - StripPrefix=2
            - name: JwtAuthenticationFilter
            - name: EmergencyPriorityFilter
        
        - id: request-service
          uri: http://request-service:8004
          predicates:
            - Path=/api/v1/blood-requests/**
          filters:
            - StripPrefix=2
            - name: JwtAuthenticationFilter
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenish-rate: 50
                redis-rate-limiter.burst-capacity: 100
        
        # GEOLOCATION SERVICE
        - id: geolocation-service
          uri: http://geolocation-service:8005
          predicates:
            - Path=/api/v1/tracking/**,/api/v1/distance/**
          filters:
            - StripPrefix=2
            - name: JwtAuthenticationFilter
        
        # NOTIFICATION SERVICE
        - id: notification-service
          uri: http://notification-service:8006
          predicates:
            - Path=/api/v1/notifications/**
          filters:
            - StripPrefix=2
            - name: JwtAuthenticationFilter
        
        # CAMP SERVICE
        - id: camp-service
          uri: http://camp-service:8007
          predicates:
            - Path=/api/v1/camps/**
          filters:
            - StripPrefix=2
            - name: JwtAuthenticationFilter
        
        # ANALYTICS SERVICE
        - id: analytics-service
          uri: http://analytics-service:8008
          predicates:
            - Path=/api/v1/analytics/**,/api/v1/rewards/**,/api/v1/leaderboards
          filters:
            - StripPrefix=2
            - name: JwtAuthenticationFilter
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenish-rate: 1000
                redis-rate-limiter.burst-capacity: 2000
      
      # ===== DEFAULT FILTERS =====
      default-filters:
        # Add correlation ID for distributed tracing
        - name: AddRequestHeader
          args:
            name: X-Correlation-Id
            value: ${spring.application.name}
        
        # Log requests and responses
        - name: Logging
      
      # ===== GLOBAL CORS CONFIG =====
      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods: 
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowedHeaders: "*"
            allowCredentials: false
            maxAge: 3600
  
  # ===== REDIS CONFIG (for rate limiting) =====
  redis:
    host: redis
    port: 6379
    password: 
    timeout: 2000ms
    jedis:
      pool:
        max-active: 8
        max-idle: 8
        min-idle: 0
  
  # ===== RABBITMQ CONFIG (for events) =====
  rabbitmq:
    host: rabbitmq
    port: 5672
    username: guest
    password: guest
    virtual-host: /
    connection-timeout: 10000

# ===== JWT CONFIG =====
jwt:
  secret: your-secret-key-change-in-production-at-least-256-bits-long
  expiration: 86400000  # 24 hours in milliseconds

# ===== LOGGING CONFIG =====
logging:
  level:
    root: INFO
    com.lifeflow: DEBUG
    org.springframework.cloud.gateway: DEBUG
    org.springframework.security: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: logs/api-gateway.log
    max-size: 10MB
    max-history: 30

# ===== MANAGEMENT/ACTUATOR CONFIG =====
management:
  endpoints:
    web:
      exposure:
        include: health,metrics,prometheus,circuitbreakers,circuitbreaker-events,retries,retry-events,timelimiters
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true
  health:
    circuitbreakers:
      enabled: true
    ratelimiters:
      enabled: true

# ===== RESILIENCE4J CONFIG =====
resilience4j:
  circuitbreaker:
    configs:
      default:
        failure-rate-threshold: 50
        slow-call-rate-threshold: 50
        slow-call-duration-threshold: 2000ms
        wait-duration-in-open-state: 30000ms
        permitted-number-of-calls-in-half-open-state: 3
        sliding-window-type: count_based
        sliding-window-size: 100
        record-exceptions:
          - java.lang.Exception
    instances:
      inventory-service:
        base-config: default
        failure-rate-threshold: 50
        wait-duration-in-open-state: 30000ms
      
      donor-service:
        base-config: default
        failure-rate-threshold: 50
        wait-duration-in-open-state: 30000ms
      
      geolocation-service:
        base-config: default
        failure-rate-threshold: 40
        wait-duration-in-open-state: 45000ms
      
      notification-service:
        base-config: default
        failure-rate-threshold: 60
        wait-duration-in-open-state: 60000ms
      
      analytics-service:
        base-config: default
        failure-rate-threshold: 70
        wait-duration-in-open-state: 60000ms
  
  retry:
    configs:
      default:
        max-attempts: 3
        wait-duration: 1000ms
        retry-exceptions:
          - java.lang.Exception
    instances:
      inventory-service:
        base-config: default
      
      donor-service:
        base-config: default
  
  timelimiter:
    configs:
      default:
        timeout-duration: 5000ms
        cancel-running-future: true
    instances:
      inventory-service:
        base-config: default
      
      donor-service:
        base-config: default

# ===== ADDITIONAL CONFIGS =====
app:
  name: LifeFlow API Gateway
  version: 1.0.0
  description: API Gateway for Blood Donation Microservices Platform
  environment: development
